# Migration Card Reminder Bot

Новая версия асинхронного Telegram-бота на **aiogram 3.x** с модульной архитектурой, автоматическими напоминаниями о сроках миграционной карты и расширяемой локализацией.

## Возможности
- Регистрация пользователя с выбором языка (RU/EN), ФИО, гражданства, телефоном и датой окончания миграционной карты.
- Фаззис-поиск гражданства по названию, коду или алиасам (rapidfuzz) с нормализованным справочником стран в базе данных.
- Автонапоминания за 30 дней до окончания миграционной карты и далее еженедельно с кнопкой «Отдал на продление» для паузы уведомлений.
- Проверка выезда из РФ после продления: бот задает вопрос и сохраняет ответы в истории.
- Администраторы (назначаются супер-админом) могут:
  - рассылать уведомления по диапазону дат окончания карт;
  - просматривать пользователей с пагинацией и отмечать продление, отправляя уведомление клиенту.
- Легко добавить новые языки через JSON-файлы в `app/locales/`.

## Структура проекта
```
app/
  main.py                # точка входа: инициализация бота, БД, планировщика, локализации
  config.py              # Pydantic-настройки
  database.py            # инициализация Async SQLAlchemy
  enums.py               # статусы миграционных карт и событий
  models.py              # модели SQLAlchemy (пользователи, админы, карты, история)
  logging.py             # базовая настройка логирования
  data/countries.json    # справочник стран с алиасами
  locales/*.json         # переводы сообщений
  services/
    localization.py      # загрузка и форматирование локализованных строк
    countries.py         # синхронизация и поиск гражданств
    migration_cards.py   # бизнес-логика работы с миграционными картами
    notifier.py          # APScheduler-уведомления
  bot/
    handlers/            # хендлеры aiogram (пользователи, админы)
    keyboards/           # inline/reply клавиатуры
    middlewares/         # middleware для сессии БД и языка
    states.py            # FSM состояния
requirements.txt
```

## Подготовка окружения
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```
Создайте файл `.env` со значениями:
```
BOT_TOKEN=123456:token
BOT_SUPERADMIN_ID=123456789
BOT_DATABASE__URL=sqlite+aiosqlite:///./bot.db   # или другой async URL
BOT_TIMEZONE=Europe/Moscow
```

## Запуск
```bash
python -m app.main
```

База данных создается автоматически при старте; справочник стран синхронизируется из `app/data/countries.json`.
